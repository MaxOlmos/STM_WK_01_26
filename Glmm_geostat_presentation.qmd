---
title: "Spatio-Temporal Modelling using Hierarchical integrated Models"
author: "Maxime Olmos, Baptiste Alglave, Jean Baptiste Lecomte"
format: thinkridentity-revealjs
---

## WHY

::: incremental

* Ecological patterns emerge from temporal and spatial processes

* But underlying mechanisms driving those processes is challenging because they are latent processes
    + challenge 1 :need approach to model those latent processes
    + challenge 2 :need spatiotemporal data
    + challenge 3 :need statistical approaches to infer latent processes from spatiotemporal data 
    
* Integrated hierarchical models are good candidates to face those challenges
    + Integrated model : use multiple sources of data to infer latent variable and processes
    + Hierachical = random effect model are good to describe spatial, temporal and spatiotemporal processes (spatially correlated random effect)

::: 


## WHY

::: incremental

![](presentation/Diapositive1.JPG)

::: 

## WHY

::: incremental

![](presentation/Diapositive2.JPG)

::: 

## WHY

::: incremental

![](presentation/Diapositive3.JPG)

::: 

## WHY

::: incremental

![](presentation/Diapositive4.JPG)

::: 

## WHY

::: incremental

![](presentation/Diapositive5.JPG)

::: 

## WHY

::: incremental

![](presentation/Diapositive6.JPG)

::: 

## WHY

::: incremental

![](presentation/Diapositive7.JPG)

::: 

## WHY

::: incremental

![](presentation/Diapositive8.JPG)

::: 

## WHY

::: incremental

![](presentation/Diapositive9.JPG)

::: 

## WHY

::: incremental

![](presentation/Diapositive10.JPG)

::: 

## WHY

::: incremental

![](presentation/Diapositive11.JPG)

::: 

## WHY

::: incremental

![](presentation/Diapositive12.JPG)

::: 

## WHY

::: incremental

![](presentation/Diapositive13.JPG)

::: 


## WORKSHOPS

::: incremental

![](prezatelier/Diapositive1.PNG)

::: 

## WORKSHOPS

::: incremental

![](prezatelier/Diapositive2.PNG)

:::

## WORKSHOPS

::: incremental

![](prezatelier/Diapositive3.PNG)

::: 

## WORKSHOPS

::: incremental

![](prezatelier/Diapositive4.PNG)

::: 

## WORKSHOPS

::: incremental

![](prezatelier/Diapositive5.PNG)

::: 

## WHAT (1/2) GLMMs with Spatial and Spatiotemporal Random Fields

::: incremental

* GLMM *Generalized Mixed effects Models*

    + Hierarchical models

    + Measured variables : predictors in a model (ex: measuring and modelling temperature effects on species abundance)

    + Unmeasured (Latent) Variables: can cause residual spatial correlations

* Geostatistical GLMM

    + With spatially correlated random effects are good tools to account for residual spatial correlation

* **But** computationally challenging

    + Due to the need to invert large matrices to account for covariation when evaluating the multivariate normal density function

* **Solution** Use the SPDE approach to approximate Gaussian random fields

    + where the random effects describing the spatial patterning are assumed to be drawn from a multivariate normal distribution,
    + constrained by covariance functions such as the exponential or Mat√©rn
:::


## WHAT (2/2) Model description

1.  Latent process 

2.  Parameters

3.  Link function and observation error distributions


## WHAT (2/2) Model description

1.  Latent process : linear predictors



$$
\begin{split}
p_{s,t} =&\underbrace{\ Œ≤_t}_{\text{Temporal variation = average temporal effect}} 
+ \underbrace{ œâ_s}_{\text{Spatial variation = niche effect}} 
+ \underbrace{Œµ_{s,t}}_{\text{Spatio-temporal variation = non obs. envir effects}} 
+ \underbrace{X_{s,t} \ Œ≤}_{\text{covariates effects}}\\
\end{split}
$$


## WHAT (2/2) Model description

1.  Latent process : linear predictors

2.  Parameters

::: panel-tabset

### Latent Spatial components 


$$ 
  \begin{split}
 \underbrace{ œâ_s}_{\text{Spatial variation}}  \sim MVN(0,Œ£_{œâ})\\
\end{split} 
$$

### Latent Spatio temp components

$$ 
  \begin{split}
 \underbrace{ Œµ_{s,t} }_{\text{Spatiotemporal variation}}  \sim MVN(0,Œ£_{Œµ})
\end{split} 
$$

### Spatial Covariance

* [**random effects**]{.underline} describing the spatial patterning are assumed to be drawn from a [**multivariate normal distribution**]{.underline} constrained by [**covariance functions**]{.underline}

![](input_images/matern.png){fig-align="center" width="500"}

### Latent Temp components

$$ 
 \begin{split}
 \underbrace{\ Œ≤ (t)}_{\text{Average temporal variation : fixed effect, IID, RW, AR }} \\  
\end{split} 
$$
   


:::

## WHAT (2/2) Model description

1.  Latent process : linear predictors

2.  Parameters

3.  Link function and observation error distributions


    + Link function $g$
$$\mu_{s,t}=g^{-1}(p_{s,t}) $$
    + Likelihood functions
    
        - The expected value $\mathbb{E[.]}$ of an observation $y$ at coordinates in space $s$ and time $t$ is defined as the mean $\mu_{s,t}$

$$
\mathbb{E}[y_{s,t}]= \mu_{s,t} 
$$

$$
y_{s,t} \sim  L(mu_{s,t}, \theta) 
$$
with $L$ any probability distribution and $\theta$ the parameters associated to this distribution


## HOW - Geostatistical GLMM packages
::: incremental

* lme4, glmmTMB commonly used (user friendly) but not SPDE approach

* [VAST](https://github.com/James-Thorson-NOAA/VAST/wiki), [tinyVAST](https://vast-lib.github.io/tinyVAST/index.html), inlabru : powerful, uses SPDE, but not user friendly

    + for multiple categories ùëê, $\mu_{s,t,c}$

        - multiple species

        - multiple size/age/sex classes for each individual species

        - a mix of biological, physical, and fishery variables describing an ecosystem

* [sdmTMB](https://pbs-assess.github.io/sdmTMB/) good candidate to fit spatiotemporal models
::: 


## HOW - CookBook - A friendly advice

::: incremental
* VAST, sdmTMB and tinyVAST has a LOT of options and can do a lot of things

* Spatiotemporal models are complex because they combine spatial, temporal and spatiotemporal processes

* Consequence : We will not present all the case studies and packages configurations

* Our workshop strategy : 
    + 1 question = Providing an Abundance Index
    + 1 model = Specific parameters to generate an Abundance Index
    + 1 configuration associated to the model

:::

## HOW - CookBook 
![](prezatelier/sdmtmb.PNG)



## HOW - CookBook - The different steps


![](input_images/steps_sdmtmb.PNG){fig-align="center" width="500"}

\~*From¬†Anderson et al.2023,* <https://doi.org/10.1101/2022.03.24.485545>\~\


## HOW -Index standardization with sdmTMB

Packages, usefull function and data

```{r}
#| echo: FALSE
#| fig-width: 10
#| fig-height: 4.5

# Load packages
library(ggplot2)
library(sdmTMB)
library(ggplot2);
library(dplyr);
library(viridis);
library("rnaturalearth");
library("rnaturalearthdata")
library(sf);
library(here)
theme_set(theme_bw())

# load data
glimpse(pcod)

# create dir
dir <- here()
dir_ex1 <-  paste0(dir,"/ex1/")

# Some spatial stuff
world <- ne_countries(scale = "medium", returnclass = "sf")
xlims <-range(pretty(pcod$lon))#range(pretty(Data_Geostat$Lon))
ylims <-range(pretty(pcod$lat))#range(pretty(Data_Geostat$Lat))

plot_map <- function(dat, column) {
  ggplot(dat, aes(X, Y, fill = {{ column }})) +
    geom_raster() +
    facet_wrap(~year) +
    coord_fixed()
}

```

## HOW -Index standardization with sdmTMB - DATA

::: panel-tabset
### Year Resolution

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5
Nber_year <- length(unique(pcod$year))
min_year <- min(pcod$year)
max_year <- max(pcod$year)

```

| Number year | starting year | end year |
|-------------|---------------|----------|
|  9          | 2003          | 2017     |

### Spatial resolution

```{r}
#| echo: true
#| fig-width: 5
#| fig-height: 5
p <- ggplot(pcod ) +
geom_point(aes(lon, lat), col="red")+
geom_sf(data=world, col=NA, fill="black")+
coord_sf(xlim = xlims, ylim = ylims)
p

```
:::

## HOW -Index standardization with sdmTMB - DATA

::: panel-tabset

### Presence/absence

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5

year_ex <- c(2003, 2007, 2015)
p_presabs <- ggplot() +
geom_point(data=as_tibble(pcod) %>% filter(year %in% year_ex),mapping=aes(lon, lat, color= (density==0)))  +
geom_sf(data=world, col=NA, fill="black")+
coord_sf(xlim = xlims, ylim = ylims)+
facet_wrap(~year)
p_presabs

```

### Intensity (Positive catch rate, catch \>0)

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5
p_int <- ggplot() +
geom_point(data=as_tibble(pcod) %>% filter(year %in% year_ex,density > 0),mapping=aes(lon, lat, color= log(density)))  +
geom_sf(data=world, col=NA, fill="black")+
coord_sf(xlim = xlims, ylim = ylims)+
scale_colour_viridis()+
facet_wrap(~year)
p_int

```

### Spatial autocorrelation ? 

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5

#https://stats.oarc.ucla.edu/r/faq/how-can-i-calculate-morans-i-in-r/
library(ape)
test_autocor <- pcod %>% filter(year=="2007")
dists <- as.matrix(dist(test_autocor[,c("lat","lon")]))
inv_dists <- 1/dists
diag(inv_dists) <- 0
Moran.I(test_autocor$density, inv_dists)

```

:::


## HOW -Index standardization with sdmTMB - DATA - Summary
::: incremental

* STEP 1 : Lots of points --> need an approach to reduce the spatial complexity to infer parameters (spatially structured random effects)

* STEP 2 : An abundance index : we need a factor predictor that represents the mean estimate for each time slice

* STEP 3 : Spatial Autocorrelation in data : need parameters to account for spatial autocorrelation

* STEP 4 : Data : Zero + intensity : likelihood to account for zero

:::

## HOW - STEP 1 : The spatial resolutions : Data, Mesh, Grid

3 spatial resolutions 

  * Data

  * Inference : knots
    
    + Provide footprint of your region of interest to run SPDE and generate knots

  * Extrapolation : predition grid

    + interpolate the predictions from knots to extrapolation grid cells, using the triangulated mesh constructed from knots (using INLA)


## HOW - STEP 1 : The spatial resolutions : Data, Mesh, Grid

::: panel-tabset

### DATA

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5

year_ex <- c(2003, 2007, 2015)
p_tot <- ggplot() +
geom_point(data=as_tibble(pcod) %>% filter(year %in% year_ex),mapping=aes(lon, lat, color= log(density)))  +
geom_sf(data=world, col=NA, fill="black")+
coord_sf(xlim = xlims, ylim = ylims)+
facet_wrap(~year)
p_tot

```

### MESH

* A relatively course mesh for a balance between speed and accuracy in this vignette (cutoff = 10 where cutoff is in the units of X and Y (km here) and represents the minimum distance between points before a new mesh vertex is added). You will  likely want to use a higher resolution mesh for applied scenarios

* You will want to make sure that increasing the number of knots does not change the conclusions.

* Number of knot should be inferior to number of data

* Mesh should have barrier to avoid barrier effects

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5

pcod_spde <- make_mesh(pcod, c("X", "Y"), cutoff = 10)
plot(pcod_spde)
```


### PREDICTION GRID


```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5

plot(qcs_grid$X,qcs_grid$Y)

```
:::

## HOW - STEP 2 : A process model to generate an abundance index 

Year fixed effect
$$ 
 \begin{split}
 \underbrace{\ Œ≤ (t)}_{\text{Average temporal variation : fixed effect }} \\  
\end{split} 
$$
   

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5

formula_IA = density ~ 0 + as.factor(year)

```



## HOW - STEP 3 :  Spatial Autocorrelation in data : need parameters to account for spatial autocorrelation 
::: panel-tabset
### Latent Spatial components 


$$ 
  \begin{split}
 \underbrace{ œâ_s}_{\text{Spatial variation}}  \sim MVN(0,Œ£_{œâ})\\
\end{split} 
$$


```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5

 spatial = "on"

```

### Latent Spatio temp components

$$ 
  \begin{split}
 \underbrace{ Œµ_{s,t} }_{\text{Spatiotemporal variation}}  \sim MVN(0,Œ£_{Œµ})
\end{split} 
$$

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5
#| 
spatiotemporal = "IID" # Independent and identically distributed 
time = "year"

```

:::

## HOW - STEP 4 :  Link function and Likelihood to account for zero

Process
$$
\begin{split}
p_{s,t} =&\underbrace{\ Œ≤_t}_{\text{Temporal variation = average temporal effect}} 
+ \underbrace{ œâ_s}_{\text{Spatial variation = niche effect}} 
+ \underbrace{Œµ_{s,t}}_{\text{Spatio-temporal variation = non obs. envir effects}}\\
\end{split}
$$
Link function $g$

$$p_{s,t} = log(mu_{s,t})$$

Likelihood functions

* The expected value $\mathbb{E[.]}$ of an observation $y$ at coordinates in space $s$ and time $t$ is defined as the mean $\mu_{s,t}$

$$
\mathbb{E}[y_{s,t}]= \mu_{s,t} 
$$

$$
y_{s,t} \sim  Tweedie(mu_{s,t}, \theta_{k}) 
$$

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5


family = tweedie(link = "log")

```

## HOW - STEP 5 :  Run the model

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5


IA <- sdmTMB(
  data = pcod, 
  formula = formula_IA,
  spatial=spatial,
  time = time, 
  spatiotemporal = spatiotemporal,
  mesh = pcod_spde, 
  family = family)


```

Quick sanity check 

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5

sanity(IA)
sa <- sanity(IA)
sa
```

## STEP 6 : Model diagnostics

::: panel-tabset
### Randomized quantile residuals

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5


pcod$resids <- residuals(IA) # randomized quantile residuals
# Also see residuals(..., type = "mle-mcmc") which are better but slower
hist(pcod$resids)

qqnorm(pcod$resids)
abline(a = 0, b = 1)

```
### QQPlot
```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5


qqnorm(pcod$resids)
abline(a = 0, b = 1)

```

### Spatial Residuals

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5


ggplot(pcod, aes(X, Y, col = resids)) + scale_colour_gradient2() +
  geom_point() + facet_wrap(~year) + coord_fixed()

```
### More about residual checking 

https://pbs-assess.github.io/sdmTMB/articles/residual-checking.html

### Cross-validation 
Cross-validation for model evaluation and comparison

https://pbs-assess.github.io/sdmTMB/articles/cross-validation.html

:::  

## STEP 7 : Parameters estimation
::: panel-tabset

### Models ouputs
```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5


IA

```
### Fixed effects

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5


tidy(IA, conf.int = TRUE)

```

### Random effects (or related paramaters)
```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5
tidy(IA, "ran_pars", conf.int = TRUE)


```


Note that standard errors are not reported when coefficients are in log space, but the confidence intervals are reported. These parameters are defined as follows:

* `range`: A derived parameter that defines the distance at which 2 points are effectively independent (actually about 13% correlated). If the `share_range` argument is changed to `FALSE` then the spatial and spatiotemporal ranges will be unique, otherwise the default is for both to share the same range.

* `phi`: Observation error scale parameter (e.g., SD in Gaussian).

* `sigma_O`: SD of the spatial process ("Omega").

* `sigma_E`: SD of the spatiotemporal process ("Epsilon").

* `tweedie_p`: Tweedie p (power) parameter; between 1 and 2.

:::

## STEP 8 : Predictions on a fine-scale grid on the entire survey domain
::: panel-tabset

### Replicate and predict

* Replicate the gride accross years
```{r}
grid_yrs <- replicate_df(qcs_grid, "year", unique(pcod$year))
```

* Predicte on grid
```{r}
predictions <- predict(IA, newdata = grid_yrs, return_tmb_object = TRUE)
```


### Temporal fixed effect

$$ 
 \begin{split}
 \underbrace{\ Œ≤ (t)}_{\text{Average temporal variation : fixed effect }} \\  
\end{split} 
$$

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5

plot_map(predictions$data, exp(est_non_rf)) +
  ggtitle("Prediction (fixed effects only)") +
  scale_fill_viridis_c(trans = "sqrt")

```
### Spatial effect


$$ 
  \begin{split}
 \underbrace{ œâ_s}_{\text{Spatial variation}}  \sim MVN(0,Œ£_{œâ})\\
\end{split} 
$$
```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5

plot_map(predictions$data, omega_s) +
  ggtitle("Spatial random effects only") +
  scale_fill_gradient2()

```

### Spatiotemporal effect
$$ 
  \begin{split}
 \underbrace{ Œµ_{s,t} }_{\text{Spatiotemporal variation}}  \sim MVN(0,Œ£_{Œµ})
\end{split} 
$$
```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5

plot_map(predictions$data, epsilon_st) +
  ggtitle("Spatiotemporal random effects only") +
  scale_fill_gradient2()

```
### Prediction

$$
\begin{split}
p_{s,t} =&\underbrace{\ Œ≤_t}_{\text{Temporal variation = average temporal effect}} 
+ \underbrace{ œâ_s}_{\text{Spatial variation = niche effect}} 
+ \underbrace{Œµ_{s,t}}_{\text{Spatio-temporal variation = non obs. envir effects}}\\
\end{split}
$$
```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5

plot_map(predictions$data, exp(est)) +
  scale_fill_viridis_c(trans = "sqrt") +
  ggtitle("Prediction (fixed effects + all random effects)")

```
:::


## STEP 9 : Abundance Index

* Index of abundance : weighted area index
* We will need to set the area argument to 4 km2 since our grid cells are 2 km x 2 km

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5

index <- get_index(predictions, area = 4, bias_correct = TRUE)
ggplot(index, aes(year, est)) + geom_line() +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.4) +
  xlab('Year') + ylab('Biomass estimate (kg)')

```

## More info

https://pbs-assess.github.io/sdmTMB/articles/index-standardization.html

## Ethics and mindset

* Participants

    + Workshop are not yet pubished
    
    + Workshop Leaders are responsible for data. **Please do not share or use those data outside of the workshop**
    
    + If you re-use the script for a futur project, please contact the workshop leader at the very least.

* Leaders

    + If you publish your work, don't forget the participants who have contributed a certain amount of work.

* These sessions are based on self-learning. It is normal if you have bugs. It is part of the learning.

* We propose a working framework for
  + learning (together) about spatio-temporal models 
  + building a community related to spatio-temporal methods for ecology.

* Finally : HAVE FUN
